module.exports=function DreadspireGuide(mod){const config=require("./config.json");const mapID=9034;const BossActions={1e3:{enabled:config.boss1,1102:{msg:"Spin",checkDouble:true},1304:{msg:"Backpedal + Spin"},1105:{msg:"Puke"},1203:{msg:"Sleep"}},2e3:{enabled:config.boss2,1101:{msg:"Smash inc"},1102:{msg:"Spin"},1105:{msg:"Back spin"},1107:{msg:"Back"},1108:{msg:"Front"},1110:{msg:"Get Out"},1122:{msg:"Get In"},1119:{msg:"Leash"}},3e3:{enabled:config.boss3,1112:{msg:"Stab + Knockup"},1134:{msg:"Debuff (closest)"},1502:{msg:"Pushback + Cage"},1130:{msg:"Left swipe",func:dakuryonLeftSwipe},1131:{msg:"Right swipe",func:dakuryonRightSwipe},1122:{isCage:true,cages:[PizzaOne,PizzaInner,PizzaOuter,PizzaTwo,PizzaLast],delay:0},1123:{isCage:true,cages:[PizzaTwo,PizzaOne,PizzaOuter,PizzaInner,PizzaLast],delay:200},1124:{isCage:true,cages:[PizzaInner,PizzaTwo,PizzaOne,PizzaOuter,PizzaLast],delay:0},1127:{isCage:true,cages:[PizzaOne,PizzaTwo,PizzaInner,PizzaOuter,PizzaLast],delay:200}},4e3:{enabled:config.boss4,1102:{msg:"Inner rings"},1103:{msg:"Outer rings"},1107:{msg:"Front"},1108:{msg:"Lines",func:MelditaLines},1109:{msg:"Single Laser"},1114:{msg:"Secondary"},1205:{msg:"360 Laser + Worms"},1206:{msg:"Triple Laser"}},5e3:{enabled:config.boss5,1103:{msg:"Tail"},1104:{msg:"Ice",func:IceAoe},1105:{msg:"Fire",func:FireAoe},1107:{msg:"Double Paw"},1118:{msg:"Big Jump + Adds"},1119:{msg:"Stun?"},1120:{msg:"Stun"},1124:{msg:"Small Jump",startTimer:true,delay:25e3,timerMsg:"Small Jump soon..."}},5002:{enabled:config.boss5,3106:{func:JinnAttack}},5003:{enabled:config.boss5,3106:{func:JinnAttack}},6e3:{enabled:config.boss6,1101:{msg:"Prison"},1103:{msg:"Slam"},1104:{msg:"Slam + Back"},1106:{msg:"Barrage + Slam"},1107:{msg:"Bomb"},1108:{msg:"Triple Bomb"},1109:{msg:"Single Swing"},1110:{msg:"Double Swing"},1113:{msg:"Laser"},1133:{msg:"Slam"},1134:{msg:"Slam + Back"},4107:{msg:"Plague/Regress",startTimer:true,delay:55e3,timerMsg:"Plague/Regress soon..."}},7e3:{enabled:config.boss7,1136:{msg:"Claw"},1138:{func:BegoneRange},1152:{msg:"Stun + Back"},1154:{msg:"Out + In",func:BegoneOutIn},1155:{msg:"In + Out",func:BegoneInOut},1240:{msg:"Donuts"},1401:{msg:"plague/regress"},1402:{msg:"sleep"},1701:{msg:"Back + Stab"},1901:{msg:"(Marks) Debuff (closest)",next:1905,prev:1903,func:LaserStarNormal},1905:{msg:"(Circles) Spread",next:1903,prev:1901,func:LaserStarNormal},1903:{msg:"(Bombs) Gather + cleanse",next:1901,prev:1905,func:LaserStarNormal},1902:{msg:"(Marks) Debuff (farthest)",next:1906,prev:1904,func:LaserStarInverted},1906:{msg:"(Circles) Gather",next:1904,prev:1902,func:LaserStarInverted},1904:{msg:"(Bombs) Gather + no cleanse",next:1902,prev:1906,func:LaserStarInverted}},8e3:{enabled:config.boss8,1101:{msg:"Push"},1102:{msg:"Pull"},1110:{msg:"Lightning"},3105:{msg:"Red Circles"}},9e3:{enabled:config.boss9,1101:{func:DarkanLeftAuto},1102:{func:DarkanRightAuto},1114:{msg:"Rake"},1115:{msg:"Puddles",startTimer:true,delay:55e3,timerMsg:"Puddles soon..."},1301:{msg:"Shout",startTimer:true,delay:55e3,timerMsg:"Shout soon..."},1302:{msg:"Bomb"},1306:{msg:"Ghost",startTimer:true,delay:55e3,timerMsg:"Ghost soon..."},1401:{func:DarkanSwipeLeft},1402:{func:DarkanSwipeRight}},1e4:{enabled:config.boss10,1102:{msg:"Donut"},1109:{msg:"Puddle"},1111:{msg:"Cage"},1112:{msg:"Stand",startTimer:true,delay:45e3,timerMsg:"Stand soon..."},1115:{msg:"Tail"},1203:{msg:"Walk"},1204:{msg:"Curl",startTimer:true,delay:4e4,timerMsg:"Curl soon..."}}};const BossHpWarnings={5e3:[{hp:.85,msg:"Pushing 85%... Big Jump + Adds soon"},{hp:.55,msg:"Pushing 55%... Big Jump + Adds soon"},{hp:.25,msg:"Pushing 25%... Big Jump + Adds soon"},{hp:.1,msg:"Pushing 10%... Big Jump + Adds soon"}],6e3:[{hp:.8,msg:"Pushing 80%... Plague/regress soon"}],7e3:[{hp:.5,msg:"Pushing 50%... Reverse order soon"}],8e3:[{hp:.5,msg:"Pushing 50%... Double balls soon"}],9e3:[{hp:.75,msg:"Pushing 75%... Puddles soon"},{hp:.7,msg:"Pushing 70%... Ghost soon"},{hp:.5,msg:"Pushing 50%... Shouts and eviscerate swipes soon"}],1e4:[{hp:.9,msg:"Pushing 90%... Stand soon"},{hp:.5,msg:"Pushing 50%... Plague/regress soon"},{hp:.08,msg:"Pushing 8%... Walk soon"}]};const HpDiffBeforeWarning=.05;const BossMessages={90340703:1901,90340704:1905,90340705:1903,9034901:{msg:"FAST Swipe inc",checkEnrage:true}};const BossAbnormalities={90340105:{msg:"Stun it!",startTimer:true,delay:6e4,timerMsg:"Stun soon..."}};const Mobs=[{templateId:5002,huntingZoneId:434},{templateId:5003,huntingZoneId:434}];const PizzaSliceDelay=1e3;const DakuryonDebuffSkip=[90340315,90340313,90340311,90340309,90340307];const DakuryonDebuffTake=[90340314,90340312,90340310,90340308,90340306];const InversedAction={1901:1902,1905:1906,1903:1904,1902:1901,1906:1905,1904:1903};const LakanNextMessageDelay=5e3;const ShieldWarningTime=8e4;const ShieldWarningMessage="Ring soon";const LakanLaserSafespots=[18,54,90,126,162,198,234,270,306,342];const LakanLaserNormalDangerOne=[0,72,144,216,288];const LakanLaserInvertedDangerOne=[36,108,180,252,324];const NpcSpawns={8100:{msg:"Curses"},8200:{msg:"Yellow Circles + Carpet"}};const Collection_Ids=[545,548];let hooks=[],enabled=config.enabled,insidemap=false,streamMode=config.streamMode,bossInfo=undefined,timers={},bossLoc=undefined,flowerId=999999999,playerDebuffs=[],bossHpWarningsNotified=[],lastSkill=undefined,dakuryonDebuffMessage="",krakatoxPlagueWarning=false,shieldWarned=false,timerNextMechanic=undefined,lastNextAction=undefined,lastInversionTime=undefined,isReversed=false,inSoulWorld=false,isEnraged=false,currentMobs=[];mod.command.add("ds",arg=>{if(arg)arg=arg.toLowerCase();if(arg===undefined){enabled=!enabled;mod.command.message(enabled?"Enabled":"Disabled")}else if(arg==="off"){enabled=false;mod.command.message(enabled?"Enabled":"Disabled")}else if(arg==="on"){enabled=true;mod.command.message(enabled?"Enabled":"Disabled")}else if(arg==="stream"){streamMode=!streamMode;mod.command.message("Stream Mode: "+(streamMode?"Enabled.":"Disabled."))}});mod.game.me.on("change_zone",(zone,quick)=>{if(zone===mapID){if(!insidemap)mod.command.message("Welcome to Dreadspire");insidemap=true;load()}else{insidemap=false;unload()}});function sendMessage(msg){if(!enabled)return;if(streamMode){mod.command.message(msg)}else{mod.send("S_CHAT",3,{channel:21,authorName:"DG-Guide",message:msg})}}function bossHealth(){return Number(bossInfo.curHp)/Number(bossInfo.maxHp)}function startTimer(message,delay,id="default"){if(timers[id])clearTimeout(timers[id]);timers[id]=setTimeout(()=>{sendMessage(message);timers[id]=null},delay)}function SpawnFlower(position,despawnDelay=1200,collectionId=Collection_Ids[1]){if(streamMode)return;if(!config.showSignsAndFlowers)return;mod.send("S_SPAWN_COLLECTION",4,{gameId:flowerId,id:collectionId,amount:1,loc:{x:position.x,y:position.y,z:bossLoc.z},w:0,extractor:false,extractorDisabled:false,extractorDisabledTime:0});setTimeout(DespawnFlower,despawnDelay,flowerId);flowerId--}function DespawnFlower(id){mod.send("S_DESPAWN_COLLECTION",2,{gameId:id,collected:false})}function SpawnLoc(degrees,radius){let rads=degrees*Math.PI/180;let finalrad=bossLoc.w-rads;let spawnx=bossLoc.x+radius*Math.cos(finalrad);let spawny=bossLoc.y+radius*Math.sin(finalrad);return{x:spawnx,y:spawny}}function dakuryonLeftSwipe(){for(let i=0;i<12;i++){SpawnFlower(SpawnLoc(90,100*i))}}function dakuryonRightSwipe(){for(let i=0;i<12;i++){SpawnFlower(SpawnLoc(270,100*i))}}function skipPizzaSlice(abnormalityId){return DakuryonDebuffSkip.includes(abnormalityId)?true:false}function PizzaOne(abnormalityId,delay){setTimeout(()=>{if(skipPizzaSlice(abnormalityId)){for(let i=0;i<6;i++){SpawnFlower(SpawnLoc(i*60+45,200))}}else{for(let i=0;i<6;i++){SpawnFlower(SpawnLoc(i*60+15,200))}}},delay)}function PizzaTwo(abnormalityId,delay){setTimeout(()=>{if(skipPizzaSlice(abnormalityId)){for(let i=0;i<6;i++){SpawnFlower(SpawnLoc(i*60+15,200))}}else{for(let i=0;i<6;i++){SpawnFlower(SpawnLoc(i*60+45,200))}}},delay)}function PizzaOuter(abnormalityId,delay){setTimeout(()=>{if(skipPizzaSlice(abnormalityId)){for(let i=0;i<12;i++){SpawnFlower(SpawnLoc(i*30+15,150))}}else{for(let i=0;i<12;i++){SpawnFlower(SpawnLoc(i*30+15,275))}}},delay)}function PizzaInner(abnormalityId,delay){setTimeout(()=>{if(skipPizzaSlice(abnormalityId)){for(let i=0;i<12;i++){SpawnFlower(SpawnLoc(i*30+15,275))}}else{for(let i=0;i<12;i++){SpawnFlower(SpawnLoc(i*30+15,150))}}},delay)}function PizzaLast(abnormalityId,delay){setTimeout(()=>{if(skipPizzaSlice(abnormalityId)){SpawnFlower(SpawnLoc(15,175),1600);SpawnFlower(SpawnLoc(105,175),1600);SpawnFlower(SpawnLoc(195,175),1600);SpawnFlower(SpawnLoc(285,175),1600)}else{SpawnFlower(SpawnLoc(45,175),1600);SpawnFlower(SpawnLoc(75,175),1600);SpawnFlower(SpawnLoc(135,175),1600);SpawnFlower(SpawnLoc(165,175),1600);SpawnFlower(SpawnLoc(225,175),1600);SpawnFlower(SpawnLoc(255,175),1600);SpawnFlower(SpawnLoc(315,175),1600);SpawnFlower(SpawnLoc(345,175),1600)}},delay)}function MelditaLines(){for(let i=1;i<6;i++){SpawnFlower(SpawnLoc(0,i*50),1500,Collection_Ids[0]);SpawnFlower(SpawnLoc(0,i*-50),1500,Collection_Ids[0])}}function IceAoe(){for(let degree=0;degree<360;degree+=360/36){SpawnFlower(SpawnLoc(degree,450),5e3,Collection_Ids[0])}}function FireAoe(){for(let degree=0;degree<360;degree+=360/36){SpawnFlower(SpawnLoc(degree,250),2e3,Collection_Ids[0])}SpawnFlower(SpawnLoc(0,500),5e3,Collection_Ids[0]);SpawnFlower(SpawnLoc(180,500),5e3,Collection_Ids[0]);SpawnFlower(SpawnLoc(50,480),5e3,Collection_Ids[0]);SpawnFlower(SpawnLoc(-50,480),5e3,Collection_Ids[0]);SpawnFlower(SpawnLoc(130,480),5e3,Collection_Ids[0]);SpawnFlower(SpawnLoc(-130,480),5e3,Collection_Ids[0])}function JinnAttack(){for(let i=1;i<10;i++){SpawnFlower(SpawnLoc(0,i*50),2500,Collection_Ids[0])}}function BegoneRange(){for(let degree=0;degree<360;degree+=360/20){SpawnFlower(SpawnLoc(degree,250),6e3,Collection_Ids[0])}}function BegoneInOut(){}function BegoneOutIn(){}function LaserStarNormal(){for(let i=0;i<LakanLaserSafespots.length;i++){SpawnFlower(SpawnLoc(LakanLaserSafespots[i],450),5e3)}for(let i=0;i<LakanLaserNormalDangerOne.length;i++){for(let radius=100;radius<1e3;radius+=50){SpawnFlower(SpawnLoc(LakanLaserNormalDangerOne[i],radius),2500,Collection_Ids[0])}}}function LaserStarInverted(){for(let i=0;i<LakanLaserSafespots.length;i++){SpawnFlower(SpawnLoc(LakanLaserSafespots[i],450),5e3)}for(let i=0;i<LakanLaserInvertedDangerOne.length;i++){for(let radius=100;radius<1e3;radius+=50){SpawnFlower(SpawnLoc(LakanLaserInvertedDangerOne[i],radius),2500,Collection_Ids[0])}}}function DarkanLeftAuto(){if(![1102].includes(lastSkill))sendMessage("Swipe inc")}function DarkanRightAuto(){if(![1101,2101].includes(lastSkill))sendMessage("Spin")}function DarkanSwipeLeft(){SpawnFlower(SpawnLoc(240,100));SpawnFlower(SpawnLoc(265,100));SpawnFlower(SpawnLoc(285,100));SpawnFlower(SpawnLoc(300,100));for(let i=0;i<12;i++){SpawnFlower(SpawnLoc(270,100*i),1500)}}function DarkanSwipeRight(){SpawnFlower(SpawnLoc(60,100));SpawnFlower(SpawnLoc(75,100));SpawnFlower(SpawnLoc(105,100));SpawnFlower(SpawnLoc(120,100));for(let i=0;i<12;i++){SpawnFlower(SpawnLoc(90,100*i),1500)}}function load(){if(!hooks.length){hook("S_BOSS_GAGE_INFO",3,event=>{bossInfo=event;let bossHp=bossHealth();if(BossHpWarnings[bossInfo.templateId]){for(let i=0;i<BossHpWarnings[bossInfo.templateId].length;i++){if(!bossHpWarningsNotified.includes(i)){if(bossHp<BossHpWarnings[bossInfo.templateId][i].hp+HpDiffBeforeWarning){bossHpWarningsNotified.push(i);sendMessage(BossHpWarnings[bossInfo.templateId][i].msg)}}}}if(bossInfo.templateId===7e3){if(bossHp<=0||bossHp>=1){lastNextAction=undefined;isReversed=false;inSoulWorld=false;shieldWarned=false;lastInversionTime=undefined}else{if(!lastInversionTime)lastInversionTime=Date.now()}if(Date.now()>lastInversionTime+ShieldWarningTime&&!shieldWarned){let hint=!inSoulWorld?BossActions[7e3][1401].msg:BossActions[7e3][1402].msg;sendMessage(ShieldWarningMessage+" -> "+hint);shieldWarned=true}}if(bossHp<=0){bossInfo=undefined;for(let timer in timers){if(timer)clearTimeout(timer)}timers={};playerDebuffs=[];flowerId=999999999;bossHpWarningsNotified=[]}});hook("S_ACTION_STAGE",9,event=>{if(!bossInfo)return;if(!BossActions[event.templateId])return;if(event.stage!=0)return;let bossAction=BossActions[event.templateId][event.skill.id];if(!bossAction)bossAction=BossActions[event.templateId][event.skill.id-1e3];if(bossAction){if(!BossActions[event.templateId].enabled)return;bossLoc=event.loc;bossLoc.w=event.w;if(bossAction.checkDouble){if(event.skill.id===lastSkill){sendMessage(bossAction.msg);lastSkill=undefined}else{lastSkill=event.skill.id}return}if(bossAction.isCage){setTimeout(()=>{for(let i=0;i<bossAction.cages.length;i++){if(playerDebuffs[i])bossAction.cages[i](playerDebuffs[i],PizzaSliceDelay*i)}},bossAction.delay)}if(bossAction.startTimer)startTimer(bossAction.timerMsg,bossAction.delay);if(bossAction.func)bossAction.func();if(bossAction.msg)sendMessage(bossAction.msg);if(bossInfo.templateId===7e3){let nextMessage;if(event.skill.id==1401||event.skill.id==2401){inSoulWorld=true;if(lastNextAction){nextMessage=BossActions[7e3][InversedAction[lastNextAction]].msg;startTimer("Next: "+nextMessage,LakanNextMessageDelay,"Lakan")}lastInversionTime=Date.now();shieldWarned=false}else if(event.skill.id==1402||event.skill.id==2402){inSoulWorld=false;if(lastNextAction){nextMessage=BossActions[7e3][InversedAction[lastNextAction]].msg;startTimer("Next: "+nextMessage,LakanNextMessageDelay,"Lakan")}lastInversionTime=Date.now();shieldWarned=false}else if(!isReversed&&bossAction.next){nextMessage=BossActions[7e3][bossAction.next].msg;startTimer("Next: "+nextMessage,LakanNextMessageDelay,"Lakan");lastNextAction=bossAction.next}else if(isReversed&&bossAction.prev){nextMessage=BossActions[7e3][bossAction.prev].msg;startTimer("Next: "+nextMessage,LakanNextMessageDelay,"Lakan");lastNextAction=bossAction.prev}}}lastSkill=event.skill.id});hook("S_ABNORMALITY_BEGIN",3,event=>{if(!bossInfo)return;if(event.target==bossInfo.id){let bossAbnormality=BossAbnormalities[event.id];if(bossAbnormality){sendMessage(bossAbnormality.msg);if(bossAbnormality.startTimer){startTimer(bossAbnormality.timerMsg,bossAbnormality.delay)}}}else if(mod.game.me.is(event.target)){if(bossInfo.templateId===3e3){if(DakuryonDebuffTake.includes(event.id)||DakuryonDebuffSkip.includes(event.id))playerDebuffs.unshift(event.id)}}});hook("S_DUNGEON_EVENT_MESSAGE",2,event=>{if(!bossInfo)return;let msgId=parseInt(event.message.replace("@dungeon:",""));if(BossMessages[msgId]){for(let timer in timers){if(timer)clearTimeout(timer)}if(bossInfo.templateId===7e3){lastNextAction=undefined;isReversed=bossHealth()<.5?true:false;if(inSoulWorld){sendMessage("Next: "+BossActions[7e3][InversedAction[BossMessages[msgId]]].msg)}else{sendMessage("Next: "+BossActions[7e3][BossMessages[msgId]].msg)}}else if(bossInfo.templateId===9e3){if(BossMessages[msgId].checkEnrage&&isEnraged){if(BossMessages[msgId].msg)sendMessage(BossMessages[msgId].msg)}}}});hook("S_NPC_STATUS",2,event=>{if(!bossInfo)return;isEnraged=event.enraged});hook("S_SPAWN_NPC",11,event=>{if(!bossInfo)return;if(bossInfo.templateId==5e3){if(!BossActions[5e3].enabled)return;for(let i=0;i<Mobs.length;i++){if(Mobs[i].templateId==event.templateId&&Mobs[i].huntingZoneId==event.huntingZoneId){currentMobs.push(event.gameId.toString())}}}else if(bossInfo.templateId==8e3){if(!BossActions[8e3].enabled)return;if(NpcSpawns[event.templateId]){sendMessage(NpcSpawns[event.templateId].msg)}}})}}function unload(){if(hooks.length){for(let h of hooks)mod.unhook(h);hooks=[]}}function hook(){hooks.push(mod.hook(...arguments))}};